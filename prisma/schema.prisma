// ========================================
// SCH√âMA PRISMA - Structure de la base de donn√©es
// ========================================
// üìñ Explication simple :
// Ce fichier d√©crit les "tables" de votre base de donn√©es.
// Chaque "model" = une table (User, Chat, Message, etc.)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== TABLES POUR L'AUTHENTIFICATION =====

// Table "users" : tous vos utilisateurs
model User {
  id            String    @id @default(cuid()) // ID unique auto-g√©n√©r√©
  name          String? // Nom (optionnel)
  email         String    @unique // Email (unique, obligatoire)
  emailVerified DateTime? // Date de v√©rification email
  password      String? // Mot de passe crypt√© (null si OAuth)
  image         String? // Photo de profil
  role          Role      @default(USER) // R√¥le : USER ou ADMIN
  createdAt     DateTime  @default(now()) // Date de cr√©ation
  updatedAt     DateTime  @updatedAt // Date de derni√®re modification

  // Relations : un User peut avoir plusieurs comptes, sessions, chats
  accounts Account[]
  sessions Session[]
  chats    Chat[]
  patients Patient[]

  @@map("users") // Nom r√©el de la table en base
}

// R√¥les possibles
enum Role {
  USER // Utilisateur normal
  ADMIN // Administrateur
}

// Table "accounts" : connexions OAuth (Google, GitHub, etc.)
model Account {
  userId            String
  type              String
  provider          String // ex: "google", "github"
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@map("accounts")
}

// Table "sessions" : sessions de connexion
model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("sessions")
}

// Table "verification_tokens" : tokens de v√©rification email
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

// ===== TABLES POUR VOTRE APPLICATION =====

// Table "chats" : conversations de vos utilisateurs
model Chat {
  id        String    @id @default(cuid())
  title     String    @default("Nouvelle conversation") // Titre du chat
  userId    String // Qui poss√®de ce chat ?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  Message[] // Liste des messages
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([userId, createdAt]) // Acc√©l√®re les recherches
  @@map("chats")
}

// Table "messages" : messages dans chaque conversation
model Message {
  id        String   @id @default(cuid())
  chatId    String // Dans quel chat ?
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  role      String // "user" ou "assistant"
  content   String   @db.Text // Texte du message
  createdAt DateTime @default(now())

  @@index([chatId, createdAt])
  @@map("messages")
}

// ===== MODULE PATIENTS & BDF =====

// Table "patients" : dossiers patients
model Patient {
  id     String  @id @default(cuid())
  userId String? // Praticien propri√©taire (optionnel)

  // Informations patient
  numeroPatient String    @unique // PAT-001, PAT-002, etc.
  nom           String
  prenom        String
  dateNaissance DateTime?
  sexe          String? // "H" | "F" | "Autre"
  telephone     String?
  email         String?
  notes         String?   @db.Text

  // ATCD & Allergies
  allergies           String? @db.Text // Legacy - texte libre des allergies (gard√© pour compatibilit√©)
  allergiesStructured Json? // PatientAllergyEntry[] - Liste structur√©e des allergies
  allergiesNotes      String? @db.Text // Notes libres sur les allergies
  atcdMedicaux        String? @db.Text
  atcdChirurgicaux    String? @db.Text
  traitements         String? @db.Text // Traitements en cours (legacy)

  // Champs pour syst√®me d'ordonnance IA
  traitementActuel          String? @db.Text // Traitements actuels d√©taill√©s
  contreindicationsMajeures Json? // string[] - CI majeures (grossesse, HTA, etc.)

  // Tags pr√©d√©finis (stock√©s en JSON array)
  tags Json? // ["Diab√®te", "Thyro√Øde", "HTA", ...]

  // === NOUVEAUX CHAMPS POUR CONTEXTE ENRICHI ORDONNANCE ===
  pathologiesAssociees Json? // string[] - Pathologies diagnostiqu√©es (ex: ["Diab√®te Type 2", "Hypothyro√Ødie", "Syndrome m√©tabolique"])
  symptomesActuels     Json? // string[] - Sympt√¥mes rapport√©s par le patient
  autresBilans         Json? // { alat?: number, asat?: number, vitamineD?: number, ... } - Autres r√©sultats biologiques

  // === TERRAIN CHRONIQUE (APCI & MALADIES CHRONIQUES) ===
  // PatientChronicProfile { apcis: PatientApciEntry[], otherDiseases: PatientChronicDiseaseEntry[] }
  chronicProfile Json? // Profil chronique complet (APCI + autres maladies chroniques hors APCI)

  // === INTERROGATOIRE ENDOBIOG√âNIQUE COMPLET ===
  interrogatoire Json? // InterrogatoireEndobiogenique - 8 axes cliniques

  // RGPD (optionnel)
  consentementRGPD Boolean   @default(false)
  dateConsentement DateTime?

  // Archivage (soft delete - suppression interdite)
  isArchived Boolean   @default(false)
  archivedAt DateTime?

  // Relations
  user               User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultations      Consultation[]
  bdfAnalyses        BdfAnalysis[]
  anthropometries    Anthropometrie[]
  ordonnances        Ordonnance[]
  ordonnanceChats    OrdonnanceChat[]
  axeInterpretations AxeInterpretation[]
  syntheseGlobale    UnifiedSynthesis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, nom, prenom])
  @@index([numeroPatient])
  @@map("patients")
}

// Table "anthropometries" : mesures anthropom√©triques
model Anthropometrie {
  id        String   @id @default(cuid())
  patientId String
  date      DateTime @default(now())

  poids  Float? // kg
  taille Float? // cm
  imc    Float? // calcul√©
  paSys  Int? // mmHg (systolique)
  paDia  Int? // mmHg (diastolique)
  pouls  Int? // bpm

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([patientId, date])
  @@map("anthropometries")
}

// Table "bdf_analyses" : analyses Biologie des Fonctions
model BdfAnalysis {
  id        String   @id @default(cuid())
  patientId String
  date      DateTime @default(now())

  // Donn√©es BdF (JSON pour flexibilit√©)
  inputs  Json // { GR, GB, LDH, CPK, TSH, etc. }
  indexes Json // BdfIndex[] (8 cartes min)
  summary String  @db.Text // R√©sum√© fonctionnel
  axes    Json // string[] des axes sollicit√©s
  ragText String? @db.Text // Lecture endobiog√©nique du terrain

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId, date])
  @@map("bdf_analyses")
}

// Table "consultations" : consultations praticien
model Consultation {
  id               String   @id @default(cuid())
  patientId        String
  dateConsultation DateTime @default(now())

  // Type et contexte
  type              String? // "initiale" | "suivi" | "urgence"
  motifConsultation String? @db.Text

  // Donn√©es BdF (copie locale depuis l'analyse)
  inputs  Json? // BdfInputs: valeurs biologiques saisies
  indexes Json? // BdfIndex[]: indexes calcul√©s
  summary String? @db.Text // R√©sum√© de l'analyse
  axes    Json? // string[]: axes th√©rapeutiques
  ragText String? @db.Text // Texte enrichi par RAG

  // Notes praticien
  commentaire   String? @db.Text
  prescriptions String? @db.Text

  // Lien optionnel vers analyse BdF (si consultation suite √† BdF)
  bdfAnalysisId String?

  // Relations
  patient         Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  bdfResults      BdfResult[]
  bdfIndexResults BdfIndexResult[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId, dateConsultation])
  @@map("consultations")
}

// Table "ordonnances" : ordonnances intelligentes en 3 volets g√©n√©r√©es par IA
model Ordonnance {
  id            String  @id @default(cuid())
  patientId     String
  bdfAnalysisId String? // Lien optionnel vers l'analyse BdF source

  // === STRUCTURE EN 4 VOLETS ===
  voletEndobiogenique Json @default("[]") // RecommandationTherapeutique[] - Endobiog√©nie
  voletPhytoElargi    Json @default("[]") // RecommandationTherapeutique[] - Phyto/Gemmo √©largi
  voletAromatherapie  Json @default("[]") // PrescriptionHE[] - Huiles essentielles d√©di√©es
  voletComplements    Json @default("[]") // RecommandationTherapeutique[] - Micro-nutrition cibl√©e

  // === CONTENU ADAPT√â TUNISIE ===
  adaptedContent Json? // PrescriptionOutput - Version adapt√©e au contexte tunisien

  // === M√âTADONN√âES ===
  syntheseClinique       String    @default("") @db.Text // Raisonnement d√©taill√© (√©tape 1: axes perturb√©s, hypoth√®ses)
  conseilsAssocies       Json      @default("[]") // string[] - Conseils hygi√©no-di√©t√©tiques
  surveillanceBiologique Json      @default("[]") // string[] - Param√®tres √† surveiller
  dateRevaluation        DateTime? // Quand revoir le patient

  // === STATUT ===
  statut String @default("brouillon") // "brouillon" | "validee" | "archivee"

  // === CONVERSATION IA ===
  chatMessagesJson Json? // ChatMessage[] - Historique conversation avec l'IA (optionnel, legacy)
  threadId         String? // Thread OpenAI Assistants API pour persistance de la conversation

  // Relations
  patient     Patient          @relation(fields: [patientId], references: [id], onDelete: Cascade)
  chatHistory OrdonnanceChat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId, createdAt])
  @@map("ordonnances")
}

// Table "ordonnance_chats" : historique chat pour ajustement ordonnances
model OrdonnanceChat {
  id           String @id @default(cuid())
  ordonnanceId String
  patientId    String
  role         String // "user" | "assistant"
  message      String @db.Text

  // Relations
  ordonnance Ordonnance @relation(fields: [ordonnanceId], references: [id], onDelete: Cascade)
  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([ordonnanceId, createdAt])
  @@index([patientId])
  @@map("ordonnance_chats")
}

// Table "axe_interpretations" : interpr√©tations IA des axes cliniques
model AxeInterpretation {
  id        String @id @default(cuid())
  patientId String
  axe       String // "neurovegetatif" | "adaptatif" | "thyroidien" | "gonadique" | "digestif" | "immuno" | "rythmes" | "axesdevie"

  // === R√âSULTAT DE L'INTERPR√âTATION IA ===
  orientation    String @db.Text // Ex: "Profil hypersympathicotonique avec tendance hypercortisolique"
  mecanismes     Json // string[] - M√©canismes fisiopatologiques identifi√©s
  prudences      Json // string[] - Points de vigilance clinique
  modulateurs    Json // string[] - Modulateurs g√©n√©riques (ex: "Plantes r√©gulatrices axe HHS")
  resumeClinique String @db.Text // Synth√®se narrative pour le praticien
  confiance      Float  @default(0.8) // Score de confiance de l'IA (0-1)

  // Relations
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([patientId, axe]) // Un seul enregistrement par axe par patient
  @@index([patientId])
  @@map("axe_interpretations")
}

// Table "synthese_globale" : synth√®se transversale de tous les axes endobiog√©niques
model UnifiedSynthesis {
  id        String @id @default(cuid())
  patientId String

  // === CONTENU DE L'ANALYSE ===
  content Json // Contenu de l'analyse au format UnifiedAnalysisOutput

  // M√©tadonn√©es
  nombreAxesAnalyses     Int     @default(0) // Nombre d'axes utilis√©s pour la synth√®se
  inclusBiologieFonction Boolean @default(false) // Inclut donn√©es BdF dans l'analyse
  confiance              Float   @default(0.8) // Score de confiance global (0-1)
  modelUsed              String? // Mod√®le IA utilis√©, ex: gpt-4o-2024-05-13
  promptVersion          String? // Version du prompt, ex: v2.1-endobiogeny-expert
  inputHash              String? // Hash des donn√©es d'entr√©e pour d√©tecter les changements
  executionTimeMs        Int? // Temps d'ex√©cution en millisecondes

  // Versioning
  version        Int     @default(1) // Num√©ro de version de cette synth√®se
  supersededById String? // ID de la version qui remplace celle-ci
  isLatest       Boolean @default(true) // Indique si c'est la version la plus r√©cente

  // Relations
  patient          Patient            @relation(fields: [patientId], references: [id], onDelete: Cascade)
  supersededBy     UnifiedSynthesis?  @relation("VersionHistory", fields: [supersededById], references: [id], onDelete: SetNull)
  previousVersions UnifiedSynthesis[] @relation("VersionHistory")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([patientId, createdAt])
  @@map("synthese_globale")
}

// ===== MODULE BDF (BIOLOGIE DES FONCTIONS) =====

// Enum : types d'index BdF
enum BdfIndexType {
  DIRECT // Index calcul√© directement depuis biomarqueurs (ex: ratio, product)
  INDIRECT // Index d√©riv√© d'autres index
  COMPOSITE // Index avec formule complexe
}

// Table "biomarkers" : biomarqueurs biologiques
model Biomarker {
  id           String   @id @default(cuid())
  code         String   @unique // ex: "TSH", "LDH", "GR"
  name         String
  unit         String?
  description  String?
  referenceMin Decimal? @db.Decimal(10, 3)
  referenceMax Decimal? @db.Decimal(10, 3)
  category     String // ex: "thyroid", "adrenal", "ionogram", "enzyme", "tumor"

  // Relations
  panels BdfPanelBiomarker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("biomarkers")
}

// Table "bdf_panels" : panels BdF (ex: Thyro√Øde Mini, BdF Standard)
model BdfPanel {
  id          String  @id @default(cuid())
  code        String  @unique // ex: "thyroid_mini", "bdf_mini"
  name        String
  description String?

  // Relations
  biomarkers BdfPanelBiomarker[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bdf_panels")
}

// Table pivot "bdf_panel_biomarkers" : Panel ‚Üî Biomarker
model BdfPanelBiomarker {
  panelId     String
  biomarkerId String
  order       Int // Ordre d'affichage clinique

  // Relations
  panel     BdfPanel  @relation(fields: [panelId], references: [id], onDelete: Cascade)
  biomarker Biomarker @relation(fields: [biomarkerId], references: [id], onDelete: Cascade)

  @@id([panelId, biomarkerId])
  @@map("bdf_panel_biomarkers")
}

// Table "bdf_index_definitions" : d√©finitions des index BdF
model BdfIndexDefinition {
  id              String       @id @default(cuid())
  code            String       @unique // ex: "idx_genital"
  name            String
  description     String?
  type            BdfIndexType
  biomarkers      Json // string[] - codes des biomarqueurs utilis√©s
  requiresIndexes Json? // string[] - codes des index requis
  formula         Json? // expression symbolique ou arbre de calcul
  category        String // ex: "thyroid", "gonadic", "corticotrope"
  subCategory     String?
  version         Int          @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bdf_index_definitions")
}

// Table "bdf_results" : valeurs biologiques d'une consultation
model BdfResult {
  id             String   @id @default(cuid())
  consultationId String
  biomarkerCode  String // Code du biomarqueur
  value          Decimal  @db.Decimal(10, 3)
  unit           String?
  referenceMin   Decimal? @db.Decimal(10, 3)
  referenceMax   Decimal? @db.Decimal(10, 3)

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([consultationId, biomarkerCode])
  @@index([consultationId])
  @@index([biomarkerCode])
  @@map("bdf_results")
}

// Table "bdf_index_results" : r√©sultats des index BdF pour une consultation
model BdfIndexResult {
  id             String   @id @default(cuid())
  consultationId String
  indexCode      String // Code de l'index
  value          Decimal? @db.Decimal(10, 3)
  category       String?
  subCategory    String?
  details        Json? // D√©tails de calcul, valeurs interm√©diaires

  // Relations
  consultation Consultation @relation(fields: [consultationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([consultationId, indexCode])
  @@index([consultationId])
  @@index([indexCode])
  @@map("bdf_index_results")
}

// ===== MODULE PHYTODEX (Biblioth√®que documentaire Tunisie / Maghreb) =====
// NOTE: Module isol√© - pas de lien avec le moteur clinique pour l'instant

/// Niveau de preuve pour les usages traditionnels
enum EvidenceLevel {
  TRADITION_ONLY // Usage rapport√© uniquement par la tradition
  PRECLINICAL_DATA // Donn√©es exp√©rimentales (in vitro / in vivo)
  SOME_CLINICAL_DATA // Quelques donn√©es cliniques humaines
}

/// Type de source bibliographique
enum SourceType {
  BOOK // Ouvrage de r√©f√©rence
  THESIS // Th√®se universitaire
  ARTICLE // Article scientifique
  FIELD_INTERVIEW // Enqu√™te de terrain
  REPORT // Rapport institutionnel
}

/// Plante documentaire du Phytodex (Tunisie / Maghreb)
model PhytodexPlant {
  id        Int     @id @default(autoincrement())
  latinName String // Ex : Rosmarinus officinalis
  family    String? // Famille botanique (optionnel pour MVP)

  // Noms vernaculaires
  mainVernacularName   String? // Nom fran√ßais courant
  arabicName           String? // Nom en arabe (ex: ÿ¥ŸÜÿØŸÇŸàÿ±ÿ©)
  otherVernacularNames String? // Liste s√©par√©e par virgules pour MVP

  // Contexte g√©ographique
  region String? // Ex : "Nord Tunisie", "Cap Bon", "Sud / zones arides"

  // Partie utilis√©e (drogue)
  partUsed String? // Ex : "Feuille", "Sommit√© fleurie", "Racine"

  // Infos "cliniques" g√©n√©rales (orient√©es terrain)
  mainActions           String? @db.Text // Ex : "Adaptog√®ne, chol√©r√©tique, l√©ger tonique"
  mainIndications       String? @db.Text // Ex : "Fatigue fonctionnelle, troubles digestifs l√©gers"
  usualForms            String? // Ex : "Infusion, g√©lules, HE"
  officinalAvailability String? // Ex : "Disponible en officine en Tunisie sous forme X"

  // S√©curit√© de base
  safetyNotes String? @db.Text // CI, pr√©cautions, grandes lignes

  // Image (cache URL Wikimedia)
  imageUrl String? // URL de l'image Wikimedia Commons

  // Bloc "usage traditionnel"
  traditionalUses TraditionalUse[]

  // M√©tadonn√©es
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([latinName])
  @@index([mainVernacularName])
  @@index([arabicName])
  @@index([region])
  @@map("phytodex_plants")
}

/// Usage traditionnel associ√© √† une plante dans le Phytodex
model TraditionalUse {
  id      Int           @id @default(autoincrement())
  plant   PhytodexPlant @relation(fields: [plantId], references: [id], onDelete: Cascade)
  plantId Int

  indicationCategory String? // Ex : "Digestif", "Respiratoire", "Stress", "Articulaire"
  indicationDetail   String  @db.Text // Ex : "Tisane pour ballonnements post-prandiaux"
  partUsed           String? // Ex : "Feuille", "Sommit√© fleurie"
  preparation        String? // Ex : "Infusion 10 min", "Mac√©ration huileuse"
  dosageNotes        String? @db.Text // Texte libre (usage traditionnel, non normalis√©)

  source   SourceReference @relation(fields: [sourceId], references: [id])
  sourceId Int

  evidenceLevel EvidenceLevel // Niveau de preuve

  createdAt DateTime @default(now())

  @@index([plantId])
  @@index([indicationCategory])
  @@map("phytodex_traditional_uses")
}

/// R√©f√©rence bibliographique pour les usages traditionnels
model SourceReference {
  id       Int        @id @default(autoincrement())
  type     SourceType
  citation String     @db.Text // R√©f√©rence bibliographique ou description courte

  uses TraditionalUse[]

  createdAt DateTime @default(now())

  @@map("phytodex_sources")
}
